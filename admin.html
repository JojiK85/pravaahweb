<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PRAVAAH ‚Äî Main Gate</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box;font-family:'Exo 2',sans-serif}
body{
  margin:0;min-height:100vh;
  background:linear-gradient(120deg,#2c1a55,#3e5d75,#022c43,#5b2a86);
  background-size:400% 400%;
  animation:bgMove 15s ease infinite;
  color:#e6fbff;padding:14px
}
@keyframes bgMove{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}
.container{
  max-width:900px;margin:auto;
  background:rgba(0,0,0,.75);
  border:2px solid cyan;border-radius:22px;
  box-shadow:0 0 35px rgba(0,255,255,.45);
  padding:20px
}
.title{text-align:center;font-size:1.6rem;font-weight:800;color:cyan}
.meta{text-align:center;font-size:.85rem;opacity:.8;margin-bottom:14px}
.status{
  padding:12px;border-radius:14px;
  font-weight:800;text-align:center;margin-bottom:16px
}
.valid{color:#00ffcc;border:1.5px solid #00ffcc}
.invalid{color:#ff6b6b;border:1.5px solid #ff6b6b}
.box{
  border:1px solid rgba(0,255,255,.4);
  padding:14px;border-radius:16px;
  background:rgba(0,0,0,.6);margin-bottom:16px
}
.participant{
  display:flex;gap:10px;padding:10px 0;
  border-bottom:1px dashed rgba(0,255,255,.3)
}
.participant input{transform:scale(1.3)}
.actions{display:flex;gap:12px}
.btn{
  flex:1;padding:14px;border-radius:16px;
  font-weight:800;border:none;font-size:1rem;cursor:pointer
}
.entry{background:#00ffcc}
.exit{background:#ff5c5c}
.btn:disabled{opacity:.4;cursor:not-allowed}
</style>
</head>

<body>
<div class="container">
  <div class="title">PRAVAAH 2026 ‚Äî Main Gate</div>
  <div class="meta">‚è∞ <span id="nowTime"></span></div>

  <div id="statusBox" class="status">Loading pass‚Ä¶</div>

  <div class="box" id="passInfo"></div>
  <div class="box" id="participantsBox"></div>

  <div class="actions">
    <button class="btn entry" disabled onclick="submitAction('ENTRY')">ALLOW ENTRY</button>
    <button class="btn exit" disabled onclick="submitAction('EXIT')">MARK EXIT</button>
  </div>

  <div style="margin-top:14px;display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
    <button class="btn" style="background:#111;color:cyan;border:1px solid cyan" onclick="goBack()">
      ‚Üê Back to Admin Dashboard
    </button>
    <button class="btn" style="background:black;color:#00ffcc;border:1px solid #00ffcc" onclick="goScanner()">
      üì∑ Open Scanner
    </button>
  </div>
</div>

<script>
const API="/api/pravaah";
const params=new URLSearchParams(location.search);
const paymentId=params.get("paymentId");
const scannerEmail=params.get("scanner");

if(!paymentId){alert("Missing Payment ID");location.href="scan.html";}
if(!scannerEmail){alert("Scanner identity missing");location.href="dashboard.html";}

const entryBtn=document.querySelector(".entry");
const exitBtn=document.querySelector(".exit");
const statusBox=document.getElementById("statusBox");

let passData,participants=[],logs=[],state={};

/* -------- FEST MAP -------- */
const DAY_MAP={
  "2026-02-05":"day0",
  "2026-02-06":"day1",
  "2026-02-07":"day2",
  "2026-02-08":"day3"
};

/* -------- TIME -------- */
function now(){
  document.getElementById("nowTime").textContent=
    new Date().toLocaleString("en-IN",{hour12:true});
}
now();setInterval(now,1000);

/* -------- FEST STATUS -------- */
function festStatus(){
  const today=new Date().toLocaleDateString("en-CA",{timeZone:"Asia/Kolkata"});
  const days=Object.keys(DAY_MAP).sort();
  const start=days[0], end=days[days.length-1];
  const dayKey=DAY_MAP[today];
  const sel=(passData["Selected Days"]||"").toLowerCase();
  const type=passData["Pass Type"];

  if(today<start) return {ok:false,text:"‚ö† Fest not started yet"};
  if(today>end) return {ok:false,text:"‚õî Pass expired ‚Äî Exit allowed"};
  if(type==="Fest Pass") return {ok:true,text:"‚úî Entry allowed today"};
  if(!dayKey) return {ok:false,text:"‚ö† Fest not active today"};
  if(sel.includes(dayKey)) return {ok:true,text:"‚úî Entry allowed today"};
  return {ok:false,text:"‚ö† Pass not valid today"};
}

/* -------- LOAD -------- */
async function loadData(){
  statusBox.className="status";
  statusBox.textContent="Loading pass‚Ä¶";
  try{
    const [p,l]=await Promise.all([
      fetch(`${API}?type=searchPass&query=${paymentId}`).then(r=>r.json()),
      fetch(`${API}?type=gatelogs&paymentId=${paymentId}`).then(r=>r.json())
    ]);
    if(!p.length) throw Error("Invalid pass");
    passData=p[0];participants=p;logs=l||[];
    resolveState();render();
  }catch(e){
    statusBox.className="status invalid";
    statusBox.textContent="‚ùå "+e.message;
  }
}
loadData();

/* -------- STATE -------- */
function resolveState(){
  state={};
  participants.forEach(p=>state[p.Name]="OUTSIDE");
  logs.slice().reverse().forEach(l=>{
    if(l.Action==="ENTRY") state[l.Name]="INSIDE";
    if(l.Action==="EXIT") state[l.Name]="OUTSIDE";
  });
}

/* -------- RENDER -------- */
function render(){
  const fest=festStatus();
  statusBox.className="status "+(fest.ok?"valid":"invalid");
  statusBox.textContent=fest.text;

  document.getElementById("passInfo").innerHTML=`
    <b>Payment ID:</b> ${passData["Payment ID"]}<br>
    <b>Pass Type:</b> ${passData["Pass Type"]}<br>
    <b>Selected Days:</b> ${passData["Selected Days"]||"‚Äî"}<br>
    <b>StarNite:</b> ${passData["Starnite"]||"‚Äî"}
  `;

  document.getElementById("participantsBox").innerHTML=
    "<h4>Select Participants</h4>"+
    participants.map(p=>{
      const s=state[p.Name];
      const disable=(s==="OUTSIDE"&&!fest.ok)?"disabled":"";
      return `
      <div class="participant">
        <input type="checkbox" ${disable}
          data-name="${p.Name}" data-state="${s}"
          data-email="${p.Email}" data-phone="${p.Phone}"
          data-college="${p.College}" onchange="updateButtons()">
        <span><b>${p.Name}</b><br>${p.Email}<br>
        <small style="color:${s==="INSIDE"?"#ffb703":"#00ffcc"}">${s}</small>
        </span>
      </div>`;
    }).join("");
  updateButtons();
}

/* -------- BUTTONS -------- */
function updateButtons(){
  const sel=[...document.querySelectorAll("input:checked")];
  entryBtn.disabled=true;exitBtn.disabled=true;
  if(!sel.length) return;
  const inside=sel.every(c=>c.dataset.state==="INSIDE");
  const outside=sel.every(c=>c.dataset.state==="OUTSIDE");
  const fest=festStatus();
  if(inside) exitBtn.disabled=false;
  if(outside&&fest.ok) entryBtn.disabled=false;
}

/* -------- SUBMIT -------- */
async function submitAction(action){
  const sel=[...document.querySelectorAll("input:checked")];
  if(!sel.length) return;

  statusBox.className="status";
  statusBox.textContent="‚è≥ Updating gate logs‚Ä¶";

  await Promise.all(sel.map(c=>fetch(API,{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      logType:action==="ENTRY"?"GATE_ENTRY":"GATE_EXIT",
      action,paymentId,
      name:c.dataset.name,email:c.dataset.email,
      phone:c.dataset.phone,college:c.dataset.college,
      passType:passData["Pass Type"],
      scanner:scannerEmail,scanMode:"GATE"
    })
  })));

  statusBox.className="status valid";
  statusBox.textContent=`‚úÖ Gate logs updated ‚Äî ${action==="ENTRY"?"Entry allowed":"Exit marked"}`;
  loadData();
}

/* -------- NAV -------- */
function goBack(){location.href="dashboard.html";}
function goScanner(){location.href=`scan.html?scanner=${encodeURIComponent(scannerEmail)}`;}
</script>
</body>
</html>
