<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PRAVAAH — Event Entry</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

<style>
*{box-sizing:border-box;font-family:'Exo 2',sans-serif}
body{
  margin:0;
  min-height:100vh;
  background:linear-gradient(120deg,#2c1a55,#3e5d75,#022c43,#5b2a86);
  background-size:400% 400%;
  animation:bgMove 15s ease infinite;
  color:#e6fbff;

  display:flex;
  align-items:center;
  justify-content:center;

  padding:20px;
}

@keyframes bgMove{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}
.container{
  max-width:900px;margin:auto;
  background:rgba(0,0,0,.75);
  border:2px solid cyan;border-radius:22px;
  box-shadow:0 0 35px rgba(0,255,255,.45);
  padding:20px
}
.title{text-align:center;font-size:1.6rem;font-weight:800;color:cyan}
.meta{text-align:center;font-size:.85rem;opacity:.8;margin-bottom:14px}
.status{
  padding:12px;border-radius:14px;
  font-weight:800;text-align:center;margin-bottom:16px
}
.valid{color:#00ffcc;border:1.5px solid #00ffcc}
.invalid{color:#ff6b6b;border:1.5px solid #ff6b6b}

.box{
  border:1px solid rgba(0,255,255,.4);
  padding:14px;border-radius:16px;
  background:rgba(0,0,0,.6);margin-bottom:16px
}

.filter-select{
  width:100%;
  padding:12px 42px 12px 16px;
  border-radius:14px;
  border:1px solid rgba(36,224,236,.5);
  background:rgba(0,0,0,.65);
  color:cyan;font-weight:700;
  appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' fill='cyan' viewBox='0 0 16 16'%3E%3Cpath d='M1.5 5.5l6 6 6-6'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right 18px center;
}

.section-title{
  margin:14px 0 6px;
  font-weight:800;
  letter-spacing:1px
}

.participant{
  display:flex;gap:10px;
  padding:10px 0;
  border-bottom:1px dashed rgba(0,255,255,.3)
}
.participant input{transform:scale(1.3)}
.participant.disabled{opacity:.45}

.btn{
  padding:14px;border-radius:16px;
  font-weight:800;border:none;
  font-size:1rem;cursor:pointer
}
.btn.primary{background:#00ffcc;color:black}
.btn.secondary{
  background:black;color:cyan;border:1px solid cyan
}
.btn:disabled{opacity:.4;cursor:not-allowed}
.actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:16px}
  .actions-vertical{
  display:flex;
  flex-direction:column;
  gap:14px;
  margin-top:18px;
}

.actions-row{
  display:flex;
  gap:12px;
}

.btn.full{
  width:100%;
}

.btn.half{
  flex:1;
}
#eventSelect{
  margin-bottom:16px;
}
#participantsBox {
  display: none;
}

</style>
</head>

<body>
<div class="container">
  <div class="title">PRAVAAH 2026 — Event Entry</div>
  <div class="meta">⏰ <span id="nowTime"></span></div>

  <div id="statusBox" class="status">Loading pass…</div>

  <div class="box" id="passInfo"></div>

  <select id="eventSelect" class="filter-select">
    <option value="">Select Event</option>
  </select>

  <div class="box" id="participantsBox"></div>

  <div class="actions-vertical">
    <button id="submitBtn" class="btn primary full" disabled>
      CONFIRM EVENT ENTRY
    </button>

    <div class="actions-row">
      <button class="btn secondary half" onclick="goDashboard()">← Back to Dashboard</button>
      <button class="btn secondary half" onclick="goScanner()">
        <i class="fa-solid fa-qrcode"></i> Open Scanner
      </button>
    </div>
  </div>
</div>

<script>
const API="/api/pravaah";
const params=new URLSearchParams(location.search);
const paymentId=params.get("paymentId");
const scanner=params.get("scanner");

if(!paymentId||!scanner){
  alert("Invalid scan");
  location.href="scan.html";
}

const statusBox=document.getElementById("statusBox");
const participantsBox=document.getElementById("participantsBox");
const eventSelect=document.getElementById("eventSelect");
const submitBtn=document.getElementById("submitBtn");

function now(){
  document.getElementById("nowTime").textContent =
    new Date().toLocaleString("en-IN",{hour12:true});
}
now(); setInterval(now,1000);

/* -------- DAY MAP -------- */
const DAY_MAP={
  "2026-02-05":"day0",
  "2025-12-20":"day1",
  "2026-02-07":"day2",
  "2026-02-08":"day3"
};

const DAY_EVENTS={
  day1:["General Quiz","Nukkad","Robowars"],
  day2:["Film Quiz","Battle of Bands","Roborace"],
  day3:["Street Battle","Enigma","Trekkon"]
};

let passData=null;
let participants=[];
let todayKey=null;

/* -------- LOAD PASS -------- */
(async function(){
  const r = await fetch(`${API}?type=searchPass&query=${paymentId}`);
  const rows = await r.json();
  passData = rows[0];
  participants = rows;
  validatePass();
})();

/* -------- STATUS LOGIC (4 CASES) -------- */
function validatePass(){
  const today = new Date().toLocaleDateString("en-CA",{timeZone:"Asia/Kolkata"});
  todayKey = DAY_MAP[today];

  if(!todayKey){
    setStatus("Fest not started today", false);
    return;
  }

  const passType = passData["Pass Type"];

if (passType === "Fest Pass") {
  setStatus("Fest Pass — Event Entry Allowed", true);
}
else if (passType === "Starnite Pass") {
  setStatus("StarNite Pass — Event Entry Allowed", true);
}
else {
  setStatus("Valid Day Pass — Event Entry Allowed", true);
}


  document.getElementById("passInfo").innerHTML = `
    <b>Payment ID:</b> ${passData["Payment ID"]}<br>
    <b>Pass Type:</b> ${passData["Pass Type"]}
  `;

  DAY_EVENTS[todayKey]?.forEach(e=>{
    const o=document.createElement("option");
    o.value=e; o.textContent=e;
    eventSelect.appendChild(o);
  });

  eventSelect.onchange = renderParticipants;
}

function setStatus(text, valid){
  statusBox.textContent = text;
  statusBox.className = "status " + (
    valid === true ? "valid" :
    valid === false ? "invalid" : ""
  );
}

/* -------- CORE LOGIC -------- */
async function renderParticipants(){
  participantsBox.innerHTML="";
  participantsBox.style.display="none";
  submitBtn.disabled=true;

  if(!eventSelect.value){
    setStatus("Select an event to continue", null);
    return;
  }

  const eventName = eventSelect.value;

  setStatus("Ready for event entry", true);

  const regRes = await fetch(
    `${API}?type=eventRegistrations&event=${encodeURIComponent(eventName)}&paymentId=${paymentId}`
  );
  const registrations = await regRes.json();

  const entryRes = await fetch(
    `${API}?type=eventEntries&event=${encodeURIComponent(eventName)}&paymentId=${paymentId}`
  );
  const entries = await entryRes.json();

  const registeredSet = new Set(registrations.map(r=>r.Name));
  const enteredSet = new Set(entries.map(e=>e.Name));

  drawSection(
    "REGISTERED",
    participants.filter(p=>registeredSet.has(p.Name)),
    enteredSet,
    "#00ffcc"
  );

  drawSection(
    "UNREGISTERED",
    participants.filter(p=>!registeredSet.has(p.Name)),
    enteredSet,
    "#ff6b6b"
  );

  if(participantsBox.children.length){
    participantsBox.style.display="block";
  }

  toggleBtn();
}

function drawSection(title,list,enteredSet,color){
  if(!list.length) return;

  const box=document.createElement("div");
  box.innerHTML=`<div class="section-title" style="color:${color}">${title}</div>`;

  const notEntered=list.filter(p=>!enteredSet.has(p.Name));
  const entered=list.filter(p=>enteredSet.has(p.Name));

  if(notEntered.length){
    box.innerHTML+=`<div class="section-title" style="font-size:.8rem;color:#00ffcc">NOT ENTERED</div>`;
    notEntered.forEach(p=>box.appendChild(buildRow(p,false)));
  }

  if(entered.length){
    box.innerHTML+=`<div class="section-title" style="font-size:.8rem;color:#ffb703">ENTERED</div>`;
    entered.forEach(p=>box.appendChild(buildRow(p,true)));
  }

  participantsBox.appendChild(box);
}

function buildRow(p,disabled){
  const row=document.createElement("div");
  row.className="participant"+(disabled?" disabled":"");
  row.innerHTML=`
    <input type="checkbox" ${disabled?"checked disabled":"checked"}
      data-name="${p.Name}" data-email="${p.Email}"
      data-phone="${p.Phone}" data-college="${p.College}"
      onchange="toggleBtn()">
    <span><b>${p.Name}</b><br>${p.Email}</span>
  `;
  return row;
}

function toggleBtn(){
  submitBtn.disabled = !document.querySelectorAll("input:checked:not(:disabled)").length;
}

/* -------- SUBMIT -------- */
submitBtn.onclick = async()=>{
  const sel=[...document.querySelectorAll("input:checked:not(:disabled)")];
  if(!sel.length) return;

  await fetch(API,{
  method:"POST",
  headers:{"Content-Type":"application/json"},
  body:JSON.stringify({
    type:"EVENT_SCAN",
    paymentId,                  // ✅ REQUIRED
    eventName:eventSelect.value,
    scanner,
    participants:sel.map(c=>({
      paymentId,
      name:c.dataset.name,
      email:c.dataset.email,
      phone:c.dataset.phone,
      college:c.dataset.college,
      passType:passData["Pass Type"]
    }))
  })
});


  alert("Event entry recorded");
  location.reload();
};

function goDashboard(){ location.href="dashboard.html"; }
function goScanner(){ location.href=`scan.html?scanner=${encodeURIComponent(scanner)}`; }
</script>
</body>
</html>
